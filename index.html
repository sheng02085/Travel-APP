<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TravelGo</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#FFFFFF">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] },
                    colors: { ios: { bg: '#F2F2F7', blue: '#007AFF', red: '#FF3B30', green: '#34C759' } },
                    boxShadow: { 'float': '0 10px 40px -10px rgba(0,0,0,0.15)' }
                }
            }
        }
    </script>
    
    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
        html, body { background-color: #FFFFFF; height: 100%; width: 100%; }
        * { -webkit-touch-callout: none; }
        input, textarea, select { -webkit-user-select: text; user-select: text; }
        .safe-top { padding-top: env(safe-area-inset-top, 20px); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
        
        /* å‹•ç•« */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        .list-enter-active, .list-leave-active { transition: all 0.3s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(10px); }

        /* è† å›Šæ¨£å¼ (Day Buttons) */
        .capsule-btn {
            @apply px-5 py-2 rounded-full text-base font-bold transition-all duration-200 border whitespace-nowrap flex items-center justify-center;
        }
        .capsule-active {
            @apply bg-gray-900 text-white border-transparent shadow-md;
        }
        .capsule-inactive {
            @apply bg-white text-gray-500 border-gray-200;
        }
    </style>
</head>

<body class="flex justify-center items-start">

    <div id="app" class="w-full h-[100dvh] bg-white flex flex-col relative overflow-hidden">
        
        <header class="absolute top-0 left-0 right-0 z-40 flex items-center justify-between px-5 pb-3 bg-white/95 backdrop-blur-sm border-b border-gray-100 safe-top min-h-[50px]">
            <h1 class="text-2xl font-bold tracking-tight text-gray-900">{{ pageTitle }}</h1>
            <button @click="openProfile" class="w-9 h-9 rounded-full bg-gray-100 overflow-hidden border border-gray-200 flex items-center justify-center active:scale-95 transition-transform">
                <img v-if="userAvatar" :src="userAvatar" class="w-full h-full object-cover">
                <i v-else class="fa-solid fa-user text-gray-400 text-sm"></i>
            </button>
        </header>

        <main class="flex-1 relative overflow-hidden pt-[calc(env(safe-area-inset-top)+55px)]">
            
            <transition name="fade" mode="out-in">
                <div v-if="currentTab === 'schedule'" key="schedule" class="flex flex-col h-full bg-gray-50">
                    
                    <div class="h-[38%] w-full relative shrink-0 bg-gray-200">
                        <iframe :src="mapSrc" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
                        <div class="absolute bottom-0 left-0 right-0 h-16 bg-gradient-to-t from-gray-50 to-transparent pointer-events-none"></div>
                    </div>

                    <div class="flex-1 bg-white rounded-t-[2rem] relative z-10 -mt-6 shadow-up flex flex-col overflow-hidden isolate ring-1 ring-black/5">
                        
                        <div class="pt-5 pb-3 px-5 bg-white border-b border-gray-50 z-20">
                            <div class="w-12 h-1.5 bg-gray-100 rounded-full mx-auto mb-4"></div>
                            <div class="flex overflow-x-auto hide-scrollbar gap-2 pb-1 items-center">
                                <button class="capsule-inactive capsule-btn !px-4 !text-sm">æ¦‚è¦½</button>
                                
                                <button v-for="day in maxDays" :key="day" 
                                    @click="currentDay = day" 
                                    :class="['capsule-btn', currentDay === day ? 'capsule-active' : 'capsule-inactive']">
                                    <span class="mr-1">6æœˆ {{ 21 + day }}æ—¥</span>
                                </button>
                                
                                <button @click="addNewDay" class="w-9 h-9 rounded-full bg-white border border-gray-300 text-gray-500 flex items-center justify-center shrink-0 active:bg-gray-100">
                                    <i class="fa-solid fa-plus text-sm"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto hide-scrollbar p-5 pb-24">
                             <div v-if="itineraryDisplay.length === 0" class="flex flex-col items-center justify-center h-40 text-gray-300">
                                <p class="text-sm font-medium">å°šç„¡è¡Œç¨‹</p>
                            </div>

                            <transition-group name="list" tag="div" class="space-y-5">
                                <div v-for="(item, index) in itineraryDisplay" :key="item.id" 
                                     @click="updateMapFocus(item.location)"
                                     class="flex gap-5 group cursor-pointer bg-white active:scale-[0.99] transition-transform">
                                    <div class="flex flex-col items-center pt-1 min-w-[50px]">
                                        <span class="text-sm font-bold text-gray-900 font-mono tracking-tight">{{ item.time }}</span>
                                        <div class="w-0.5 h-full bg-gray-100 mt-2 rounded-full relative"><div class="absolute top-0 left-1/2 -translate-x-1/2 w-2 h-2 bg-gray-300 rounded-full group-hover:bg-black transition-colors"></div></div>
                                    </div>
                                    <div class="flex-1 pb-5 border-b border-gray-50">
                                        <div class="flex justify-between items-start">
                                            <div class="space-y-1.5">
                                                <h3 class="font-bold text-gray-900 text-lg leading-snug">{{ item.title }}</h3>
                                                <div v-if="item.transport && item.transport !== 'none'" class="inline-flex items-center gap-1.5 text-gray-600 bg-gray-100 px-2.5 py-1 rounded-lg text-xs font-bold">
                                                    <span v-html="getTransportIcon(item.transport)"></span><span>{{ getTransportName(item.transport) }}</span>
                                                </div>
                                                <p class="text-xs text-gray-400 flex items-center"><i class="fa-solid fa-location-dot text-[10px] mr-1.5 text-gray-300"></i>{{ item.location }}</p>
                                            </div>
                                            <button @click.stop="deleteSchedule(item.id)" class="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-500 transition-colors -mr-2"><i class="fa-solid fa-trash-can text-sm"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </transition-group>
                        </div>

                        <button @click="showAddSchedule = true" class="absolute bottom-6 right-6 w-14 h-14 bg-black text-white rounded-full shadow-float flex items-center justify-center text-2xl active:scale-90 transition z-30">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div v-else-if="currentTab === 'wallet'" key="wallet" class="h-full overflow-y-auto p-5 bg-white pb-24">
                    <div class="bg-gray-900 text-white p-7 rounded-[2rem] shadow-float relative overflow-hidden mb-6">
                        <div class="relative z-10"><p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Total Spent</p><h2 class="text-4xl font-bold tracking-tight">NT$ {{ totalExpense.toLocaleString() }}</h2></div>
                        <i class="fa-brands fa-cc-visa absolute -bottom-4 -right-2 text-8xl text-white/10 rotate-12"></i>
                    </div>
                    <div class="bg-gray-50 p-5 rounded-[1.5rem] mb-6 border border-gray-100 space-y-4">
                        <div class="flex gap-3"><input v-model="newExpense.name" placeholder="æ¶ˆè²»é …ç›®" class="flex-1 bg-white p-4 rounded-xl text-sm font-bold outline-none"><input v-model.number="newExpense.amount" type="number" placeholder="$" class="w-24 bg-white p-4 rounded-xl text-sm font-bold outline-none text-center"></div>
                        <div class="flex gap-2"><button @click="newExpense.type = 'cash'" :class="newExpense.type === 'cash' ? 'bg-white text-black' : 'text-gray-400'" class="flex-1 py-3 rounded-xl text-xs font-bold transition-all bg-white">ç¾é‡‘</button><button @click="newExpense.type = 'card'" :class="newExpense.type === 'card' ? 'bg-white text-ios-blue' : 'text-gray-400'" class="flex-1 py-3 rounded-xl text-xs font-bold transition-all bg-white">ä¿¡ç”¨å¡</button><button @click="addExpense" class="bg-black text-white w-12 rounded-xl flex items-center justify-center"><i class="fa-solid fa-plus"></i></button></div>
                    </div>
                    <div class="space-y-3"><div v-for="(expense, idx) in expenses" :key="expense.id" class="bg-white p-4 rounded-2xl border border-gray-100 flex justify-between items-center shadow-sm"><div class="flex items-center gap-4"><div class="w-10 h-10 rounded-full flex items-center justify-center text-sm" :class="expense.type === 'card' ? 'bg-blue-50 text-ios-blue' : 'bg-green-50 text-green-600'"><i :class="expense.type === 'card' ? 'fa-solid fa-credit-card' : 'fa-solid fa-money-bill'"></i></div><span class="font-bold text-gray-800">{{ expense.name }}</span></div><span class="font-bold text-gray-900">-{{ expense.amount }}</span></div></div>
                </div>

                <div v-else-if="currentTab === 'shop'" key="shop" class="h-full overflow-y-auto p-5 bg-white pb-24">
                    <div class="flex gap-2 mb-6"><input v-model="newShopItem" @keyup.enter="addShopItem" type="text" placeholder="æ–°å¢å¾…è³¼..." class="flex-1 bg-gray-50 border border-gray-100 p-4 rounded-2xl font-bold text-sm outline-none"><button @click="addShopItem" class="bg-black text-white px-6 rounded-2xl font-bold shadow-md"><i class="fa-solid fa-plus"></i></button></div>
                    <div class="space-y-3"><div v-for="(item, idx) in shopList" :key="item.id" class="bg-white p-4 rounded-2xl border border-gray-100 flex items-center justify-between" :class="item.done ? 'opacity-50' : ''"><div @click="toggleShopItem(idx)" class="flex items-center gap-4 flex-1 cursor-pointer"><div class="w-6 h-6 rounded-full border-2 flex items-center justify-center" :class="item.done ? 'bg-black border-black' : 'border-gray-200'"><i v-if="item.done" class="fa-solid fa-check text-white text-[10px]"></i></div><span class="font-bold text-gray-800 text-base" :class="{'line-through': item.done}">{{ item.name }}</span></div><button @click="deleteShopItem(idx)" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></div></div>
                </div>

                <div v-else-if="currentTab === 'flight'" key="flight" class="h-full overflow-y-auto p-5 bg-white pb-24">
                    <div class="bg-gray-50 p-6 rounded-[1.5rem] space-y-5 mb-6 border border-gray-100 shadow-sm">
                        <div class="flex justify-between items-center"><h3 class="font-bold text-gray-900 text-lg">æ–°å¢æ©Ÿç¥¨</h3></div>
                        
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">èˆªç©ºå…¬å¸</label>
                                <input v-model="newFlight.airline" placeholder="èˆªç©º" class="w-full bg-white p-3 rounded-xl text-sm font-bold outline-none shadow-sm">
                            </div>
                            <div class="w-32">
                                <label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">ç­æ¬¡</label>
                                <input v-model="newFlight.flightNo" @change="autoFillFlight" list="flight-options" placeholder="ex: JX800" class="w-full bg-white p-3 rounded-xl text-sm font-bold outline-none shadow-sm">
                                <datalist id="flight-options">
                                    <option value="JX800">
                                    <option value="JX801">
                                    <option value="BR198">
                                    <option value="BR197">
                                    <option value="CI100">
                                </datalist>
                            </div>
                        </div>
                        
                        <div class="flex gap-4">
                            <div class="flex-1"><label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">å‡ºç™¼åœ°</label><input v-model="newFlight.from" class="w-full bg-white p-3 rounded-xl text-sm font-bold outline-none shadow-sm"></div>
                            <div class="flex-1"><label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">ç›®çš„åœ°</label><input v-model="newFlight.to" class="w-full bg-white p-3 rounded-xl text-sm font-bold outline-none shadow-sm"></div>
                        </div>
                        
                        <div><label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">æ—¥æœŸ</label><input v-model="newFlight.date" type="date" class="w-full bg-white p-3 rounded-xl text-sm font-bold outline-none shadow-sm"></div>
                        
                        <div class="flex gap-4">
                            <div class="flex-1"><label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">èµ·é£›</label><input v-model="newFlight.depTime" type="time" class="w-full bg-white p-3 rounded-xl text-sm font-bold outline-none shadow-sm"></div>
                            <div class="flex-1"><label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">æŠµé”</label><input v-model="newFlight.arrTime" type="time" class="w-full bg-white p-3 rounded-xl text-sm font-bold outline-none shadow-sm"></div>
                        </div>
                        
                        <button @click="addFlight" class="w-full bg-black text-white py-3.5 rounded-xl text-sm font-bold shadow-md active:scale-95 transition mt-2">ç¢ºèªæ–°å¢</button>
                    </div>

                    <div class="space-y-4">
                        <div v-for="(ticket, idx) in flightList" :key="ticket.id" class="bg-white rounded-[1.5rem] border border-gray-200 shadow-sm overflow-hidden"><div class="h-2 bg-ios-blue w-full"></div><div class="p-5 relative"><div class="flex justify-between items-start mb-6"><div><h3 class="font-bold text-gray-900 text-lg">{{ ticket.airline }} <span class="text-gray-500 text-base ml-1">{{ ticket.flightNo }}</span></h3></div><i class="fa-solid fa-plane text-gray-100 text-2xl"></i></div><div class="flex justify-between items-center mb-6"><div class="text-center"><p class="text-3xl font-black text-gray-800">{{ ticket.from }}</p><p class="text-[10px] text-gray-400 mt-1 font-mono">{{ ticket.depTime }}</p></div><div class="flex-1 flex flex-col items-center px-4"><i class="fa-solid fa-plane text-gray-300 rotate-90 mb-1"></i><div class="w-full h-px bg-gray-200"></div></div><div class="text-center"><p class="text-3xl font-black text-gray-800">{{ ticket.to }}</p><p class="text-[10px] text-gray-400 mt-1 font-mono">{{ ticket.arrTime }}</p></div></div><button @click="deleteFlight(idx)" class="absolute top-5 right-5 text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div></div>
                    </div>
                </div>

            </transition>

            <transition name="fade">
                <div v-if="showAddSchedule" class="absolute inset-0 z-50 bg-black/50 backdrop-blur-[2px] flex items-center justify-center p-5">
                    <transition name="slide-up" appear>
                        <div v-if="showAddSchedule" class="bg-white w-full max-w-xs rounded-[2rem] shadow-2xl p-6 relative">
                            
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-gray-900 text-xl">æ–°å¢è¡Œç¨‹</h3>
                                <button @click="showAddSchedule = false" class="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-gray-500"><i class="fa-solid fa-times"></i></button>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 mb-5">
                                <div class="bg-gray-50 p-3 rounded-2xl"><label class="text-[10px] text-gray-400 font-bold block mb-1">æ™‚é–“</label><input v-model="newSchedule.time" type="time" class="bg-transparent w-full font-bold text-base outline-none"></div>
                                <div class="bg-gray-50 p-3 rounded-2xl"><label class="text-[10px] text-gray-400 font-bold block mb-1">äº¤é€š</label><select v-model="newSchedule.transport" class="bg-transparent w-full font-bold text-base outline-none"><option value="walk">ğŸš¶ æ­¥è¡Œ</option><option value="train">ğŸš‡ åœ°éµ</option><option value="taxi">ğŸš• è¨ˆç¨‹è»Š</option><option value="none">ğŸ“ å®šé»</option></select></div>
                            </div>

                            <div class="mb-5">
                                <label class="text-[10px] text-gray-400 font-bold block mb-2">æ—…éŠåœ°å€</label>
                                <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1">
                                    <button v-for="region in ['æ±äº¬', 'å¤§é˜ª', 'äº¬éƒ½']" @click="newSchedule.region = region" :class="newSchedule.region === region ? 'bg-black text-white' : 'bg-white border border-gray-200 text-gray-500'" class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">{{ region }}</button>
                                </div>
                            </div>

                            <div class="space-y-3 mb-6">
                                <input v-model="newSchedule.title" placeholder="æ™¯é»åç¨±" class="w-full bg-gray-50 p-4 rounded-2xl text-sm font-bold outline-none">
                                <input v-model="newSchedule.location" placeholder="Google Maps åœ°é»" class="w-full bg-gray-50 p-4 rounded-2xl text-sm outline-none">
                            </div>
                            
                            <button @click="addScheduleItem" class="w-full bg-black text-white py-4 rounded-2xl font-bold text-base shadow-lg active:scale-95 transition-transform">ç¢ºèªæ–°å¢</button>
                        </div>
                    </transition>
                </div>
            </transition>

        </main>

        <nav v-if="currentTab !== 'profile'" class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around items-start pt-3 pb-safe-bottom z-50 safe-bottom min-h-[60px] shadow-[0_-5px_20px_rgba(0,0,0,0.02)]">
            <button @click="currentTab = 'schedule'" class="flex flex-col items-center w-16 group transition-all duration-200 active:scale-90"><i class="fa-solid fa-map-location-dot text-xl mb-1.5 transition-colors" :class="currentTab === 'schedule' ? 'text-black' : 'text-gray-300'"></i><span class="text-[10px] font-bold transition-colors" :class="currentTab === 'schedule' ? 'text-black' : 'text-gray-300'">è¡Œç¨‹</span></button>
            <button @click="currentTab = 'wallet'" class="flex flex-col items-center w-16 group transition-all duration-200 active:scale-90"><i class="fa-solid fa-wallet text-xl mb-1.5 transition-colors" :class="currentTab === 'wallet' ? 'text-black' : 'text-gray-300'"></i><span class="text-[10px] font-bold transition-colors" :class="currentTab === 'wallet' ? 'text-black' : 'text-gray-300'">è¨˜å¸³</span></button>
            <button @click="currentTab = 'shop'" class="flex flex-col items-center w-16 group transition-all duration-200 active:scale-90"><i class="fa-solid fa-bag-shopping text-xl mb-1.5 transition-colors" :class="currentTab === 'shop' ? 'text-black' : 'text-gray-300'"></i><span class="text-[10px] font-bold transition-colors" :class="currentTab === 'shop' ? 'text-black' : 'text-gray-300'">è³¼ç‰©</span></button>
            <button @click="currentTab = 'flight'" class="flex flex-col items-center w-16 group transition-all duration-200 active:scale-90"><i class="fa-solid fa-plane-up text-xl mb-1.5 transition-colors" :class="currentTab === 'flight' ? 'text-black' : 'text-gray-300'"></i><span class="text-[10px] font-bold transition-colors" :class="currentTab === 'flight' ? 'text-black' : 'text-gray-300'">ç™»æ©Ÿ</span></button>
        </nav>

        <transition name="slide-up">
            <div v-if="currentTab === 'profile'" class="absolute inset-0 bg-white z-[60] flex flex-col safe-top">
                <div class="h-14 flex items-center justify-between px-5 border-b border-gray-100 bg-white"><span class="font-bold text-lg">å€‹äººä¸­å¿ƒ</span><button @click="closeProfile" class="text-ios-blue font-bold text-sm bg-blue-50 px-4 py-1.5 rounded-full">å®Œæˆ</button></div>
                <div class="p-8 flex flex-col items-center space-y-8 mt-10"><div class="w-28 h-28 rounded-full bg-gray-50 border border-gray-100 flex items-center justify-center"><i v-if="!userAvatar" class="fa-solid fa-user text-4xl text-gray-300"></i><img v-else :src="userAvatar" class="w-full h-full object-cover"></div><div class="w-full max-w-xs space-y-1 text-center"><label class="text-xs font-bold text-gray-400 uppercase tracking-widest">Your Name</label><input v-model="userName" @input="saveToLocal" type="text" class="text-center text-2xl font-bold bg-transparent border-b border-gray-200 w-full outline-none py-2 focus:border-black" placeholder="è¼¸å…¥åå­—"></div><button @click="resetAllData" class="text-red-500 font-bold text-sm">æ¸…é™¤æ‰€æœ‰è³‡æ–™ (é‡ç½®)</button></div>
            </div>
        </transition>

    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        createApp({
            setup() {
                const currentTab = ref('schedule');
                const previousTab = ref('schedule');
                
                const currentDay = ref(1); const showAddSchedule = ref(false);
                const itineraryData = ref([]); const expenses = ref([]); const shopList = ref([]); const flightList = ref([]); 
                const userName = ref(''); const userAvatar = ref('');
                const mapQuery = ref('Tokyo');

                const newSchedule = ref({ time: '10:00', title: '', location: '', transport: 'walk', region: 'æ±äº¬' }); 
                const newExpense = ref({ name: '', amount: '', type: 'cash' }); const newShopItem = ref('');
                
                // ä¿®æ­£ï¼šé è¨­å€¼
                const newFlight = ref({ airline: 'æ˜Ÿå®‡èˆªç©º', flightNo: '', from: '', to: '', date: '', depTime: '', arrTime: '', gate: '' });

                const ensureId = (list) => list.forEach(item => { if(!item.id) item.id = Date.now() + Math.random(); });

                const openProfile = () => { previousTab.value = currentTab.value; currentTab.value = 'profile'; };
                const closeProfile = () => { currentTab.value = previousTab.value; };

                const saveToLocal = () => {
                    localStorage.setItem('tg_itinerary', JSON.stringify(itineraryData.value));
                    localStorage.setItem('tg_expenses', JSON.stringify(expenses.value));
                    localStorage.setItem('tg_shop', JSON.stringify(shopList.value));
                    localStorage.setItem('tg_flights', JSON.stringify(flightList.value));
                    localStorage.setItem('tg_name', userName.value);
                };
                const loadFromLocal = () => {
                    try {
                        if(localStorage.getItem('tg_itinerary')) { itineraryData.value = JSON.parse(localStorage.getItem('tg_itinerary')); ensureId(itineraryData.value); }
                        if(localStorage.getItem('tg_expenses')) { expenses.value = JSON.parse(localStorage.getItem('tg_expenses')); ensureId(expenses.value); }
                        if(localStorage.getItem('tg_shop')) { shopList.value = JSON.parse(localStorage.getItem('tg_shop')); ensureId(shopList.value); }
                        if(localStorage.getItem('tg_flights')) { flightList.value = JSON.parse(localStorage.getItem('tg_flights')); ensureId(flightList.value); }
                        if(localStorage.getItem('tg_name')) userName.value = localStorage.getItem('tg_name');
                    } catch(e) {}
                };
                onMounted(() => loadFromLocal());

                const pageTitle = computed(() => ({ schedule: 'æˆ‘çš„è¡Œç¨‹', wallet: 'æ—…è¡ŒéŒ¢åŒ…', shop: 'è³¼ç‰©æ¸…å–®', flight: 'ç™»æ©Ÿè­‰', profile: 'å€‹äººä¸­å¿ƒ' }[currentTab.value] || 'TravelGo'));
                const maxDays = computed(() => itineraryData.value.length ? Math.max(currentDay.value, Math.max(...itineraryData.value.map(i => i.day))) : currentDay.value);
                const itineraryDisplay = computed(() => itineraryData.value.filter(item => item.day === currentDay.value).sort((a, b) => a.time.localeCompare(b.time)));
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
                
                // ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„ JS æ¨¡æ¿å­—ä¸²èªæ³•ç”Ÿæˆåœ°åœ–é€£çµï¼Œè§£æ±º 404
                const mapSrc = computed(() => `https://maps.google.com/maps?q=${encodeURIComponent(mapQuery.value)}&t=&z=13&ie=UTF8&iwloc=&output=embed`);
                
                const updateMapFocus = (location) => { if(location) mapQuery.value = location; };
                const getTransportIcon = (t) => { const icons = { 'walk': '<i class="fa-solid fa-person-walking"></i>', 'train': '<i class="fa-solid fa-train-subway"></i>', 'taxi': '<i class="fa-solid fa-taxi"></i>', 'none': '<i class="fa-solid fa-map-pin"></i>' }; return icons[t] || icons['none']; };
                const getTransportName = (t) => { const names = { 'walk': 'æ­¥è¡Œ', 'train': 'åœ°éµ', 'taxi': 'è¨ˆç¨‹è»Š', 'none': 'å®šé»' }; return names[t] || ''; };

                const addNewDay = () => { currentDay.value = maxDays.value + 1; };
                const addScheduleItem = () => { 
                    if(newSchedule.value.title) { 
                        itineraryData.value.push({ id: Date.now(), day: currentDay.value, ...newSchedule.value }); 
                        updateMapFocus(newSchedule.value.location);
                        const savedRegion = newSchedule.value.region;
                        newSchedule.value = { time: '10:00', title: '', location: '', transport: 'walk', region: savedRegion }; 
                        showAddSchedule.value = false; saveToLocal(); 
                    }
                };
                const deleteSchedule = (id) => { if(confirm('åˆªé™¤ï¼Ÿ')) { itineraryData.value = itineraryData.value.filter(i => i.id !== id); saveToLocal(); }};
                const addExpense = () => { if(newExpense.value.name && newExpense.value.amount) { expenses.value.unshift({ id: Date.now(), ...newExpense.value }); newExpense.value.name = ''; newExpense.value.amount = ''; saveToLocal(); }};
                const deleteExpense = (idx) => { expenses.value.splice(idx, 1); saveToLocal(); };
                const addShopItem = () => { if(newShopItem.value) { shopList.value.unshift({ id: Date.now(), name: newShopItem.value, done: false }); newShopItem.value = ''; saveToLocal(); }};
                const toggleShopItem = (idx) => { shopList.value[idx].done = !shopList.value[idx].done; saveToLocal(); };
                const deleteShopItem = (idx) => { shopList.value.splice(idx, 1); saveToLocal(); };
                const addFlight = () => { 
                    if(newFlight.value.flightNo) { 
                        flightList.value.push({ id: Date.now(), ...newFlight.value }); 
                        newFlight.value = { airline: 'æ˜Ÿå®‡èˆªç©º', flightNo: '', from: '', to: '', date: '', depTime: '', arrTime: '', gate: '' }; 
                        saveToLocal(); 
                    }
                };
                
                // è‡ªå‹•å¸¶å…¥ç­æ©Ÿè³‡æ–™çš„æ¨¡æ“¬é‚è¼¯
                const autoFillFlight = () => {
                    const code = newFlight.value.flightNo.toUpperCase();
                    if(code.includes('JX800')) { newFlight.value.from = 'TPE'; newFlight.value.to = 'NRT'; newFlight.value.depTime = '08:30'; newFlight.value.arrTime = '12:45'; }
                    else if(code.includes('JX801')) { newFlight.value.from = 'NRT'; newFlight.value.to = 'TPE'; newFlight.value.depTime = '13:55'; newFlight.value.arrTime = '16:25'; }
                    else if(code.includes('BR198')) { newFlight.value.from = 'TPE'; newFlight.value.to = 'NRT'; newFlight.value.depTime = '08:50'; newFlight.value.arrTime = '13:15'; }
                    else if(code.includes('CI100')) { newFlight.value.from = 'TPE'; newFlight.value.to = 'NRT'; newFlight.value.depTime = '09:30'; newFlight.value.arrTime = '13:30'; }
                };

                const deleteFlight = (idx) => { if(confirm('åˆªé™¤é€™å¼µæ©Ÿç¥¨ï¼Ÿ')) { flightList.value.splice(idx, 1); saveToLocal(); }};
                const resetAllData = () => { if(confirm('æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')) { itineraryData.value = []; expenses.value = []; shopList.value = []; flightList.value = []; userName.value = ''; saveToLocal(); alert('å·²é‡ç½®'); }};

                return { currentTab, currentDay, maxDays, showAddSchedule, itineraryData, itineraryDisplay, expenses, shopList, flightList, userName, userAvatar, newSchedule, newExpense, newShopItem, newFlight, pageTitle, totalExpense, mapSrc, getTransportIcon, getTransportName, updateMapFocus, addNewDay, addScheduleItem, deleteSchedule, addExpense, deleteExpense, addShopItem, toggleShopItem, deleteShopItem, addFlight, deleteFlight, resetAllData, saveToLocal, openProfile, closeProfile, autoFillFlight };
            }
        }).mount('#app');
    </script>
</body>
</html>